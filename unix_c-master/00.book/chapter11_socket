第１１章　连接到近端或远端的进程：服务器与Socket(套接字)

一些程序被作为单独的进程建立起来来接受和发送数据．在客户/服务器模型中，
服务器进程为客户进程提供处理或数据服务

客户/服务器系统包含通信系统和协议．客户和服务器通过管道或socket进行通信．
协议是会话过程中一系列规则的集合

popen库函数可以将任何shell程序嵌入服务器程序并且让对服务器的访问就像访问
缓存文件一样

管道是一对相连接的文件描述符．socket是一个未连接的通信端点，也是一个潜在
的文件描述符．客户进程通过把自己的socket和服务器端的socket相连来创建一个
通信连接

sockets之间的连接可以扩展到另一台机器上．每个socket以机器地址和端口来标识

到管道和socket的连接使用文件描述符．文件描述符为程序提供了与文件，设备和
其他的进程通信的统一编程接口

Unix中的计算器:bc
bc在内部启动了dc计算器程序，并通过管道与其进行通信

从bc方法中得到的思想：
１　客户/服务器模型
    bc/dc程序对是客户/服务器模型程序设计的一个实例．bc通过用户界面，
    并使用dc提供的服务．这里bc被称为dc的客户
２　双向通信
    客户/服务器模型不同于生产线的数据处理模型，他要求一个进程既跟另
    一个进程的标准输入也要和他的标准输出进行通信
３　永久性服务
    bc让单一的dc进程处于运行状态，也就是bc不断的与dc的同一个实例进行
    通信，而shell对每一个命令都创建一个新的进程
    bc/dc对被称之为协同进程(coroutines)以用来区别于子程序(subroutines)
    两个程序都持续运行，当其中的一个程序完成自己的工作后将把控制权传给
    另一个程序

bc的流程：
１　创建两个管道
２  创建一个进程来运行dc
３  在新创建的进程中，重定向标准输入和标准输出到管道，然后运行exec dc
４  在父进程中，读取并分析用户的输入，将命令传给dc,dc读取响应，并把
    响应传给用户

如果知道文件名，可以用fopen打开设备文件
如果只知道文件描述符，可以用fdopen命令:W

fopen打开一个指向文件的带缓冲的连接
FILE * fp;
fp = fopen("file", "r");
c = getc(fp);
fgets(buf, len, fp);
fscanf(fp, "%d%d%s", &x, &y, &z);
fclose(fp);

popen打开一个指向进程的带缓冲的连接
FILE * fp;
fp = popen("ls", "r");
fgets(buf, len, fp);
pclose(fp);

如果不关闭，进程会变成僵尸进程．pclose中调用了wait函数等待进程的结束

访问数据：文件，应用程序接口，服务器
文件
    依赖于特定的文件格式和结构体中特定的成员名称
函数
    就算底层存储结构改变，接口程序依然可用
进程
    使用进程，也就是调用独立的程序来获取数据，而不是自己写的程序


管道使得进程对其他进程发送数据就像向文件发送数据一样容易，但是因为管道
在进程中被创建，通过fork来实现共享，所以管道只能连接位于同一台主机上的
进程，而要与远端进程连接，需要使用socket

客户和服务器
    服务器是提供服务的程序，是一个进程，等待请求，处理请求，然后循环回去
    等下一个请求．客户端进程只要建立连接，与服务器交换数据即可

主机名和端口
    运行于因特网上的服务器其实是某台计算器上运行的一个进程．服务器在该
    主机拥有一个端口．主机和端口的组合才标识了一个服务器

协议
    协议是服务器和客户之间交互的规则．每个客户/服务器模型都必须定义一个
    协议并遵守,只要两者相互认可就行，比如约定数据的格式等

/etc/services中定义了常用的服务器端口列表

socket中服务器流程：
１　向内核申请一个socket
    socket是一个通信端点　系统调用socket创建一个socket
２  绑定地址到socket上，地址包括主机，端口
    bind调用把一个地址分配给socket
３  在socket上，允许接入呼叫并设置队列长度
    使用listen 监听端口
４　等待/接收呼叫
    使用accept来接收调用，accept阻塞当前进程，直到指定socket上的接入连接
    被建立起来，然后返回文件描述符进行读写操作
５  传输数据
６  关闭连接
    close系统调用

socket中客户端流程：
１　向内核申请建立socket
２  与服务器连接
    connect系统调用
３  传送数据
４  关闭连接

对于任何运行参数中所含的命令或从因特网上获取数据的服务器，在编写时都要格外
小心，比如收到用户参数里有";rm *"

